<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/layout/css/cosmuic.css">
<link rel="stylesheet" href="/layout/css/styles.css">
<title>Mystic's Web: Karaoke Editor</title>
<style>
body {
    font-family: sans-serif;
}

.tag-row {
    margin-bottom: 5px;
}

.tag-row input {
    margin-left: 5px;
}

.removeBtn {
    margin: 0;
    min-width: 1rem;
    height: auto;
    line-height: 1.25rem;
    padding: 0 0.5rem;
}

#cover {
    max-width: 200px;
    max-height: 200px;
    border: 1px solid #ccc;
    margin-top: 5px;
    display: block;
}
</style>
</head>
<body>

<header data-nav="left">
<iframe src="/layout/header.html" onload="this.insertAdjacentHTML('afterend', (this.contentDocument.body||this.contentDocument).innerHTML);this.remove()"></iframe>
</header>

<main>
    <h2>Advanced MP3 Tag Editor</h2>

    <input type="file" id="fileInput" accept="audio/mpeg"><br><br>

    <div id="tagInfo" style="display:none;">
        <div id="tagList"></div>
        <button id="addTagBtn">Add Tag</button>
        <br><br>

        <div>
            <strong>Cover Art:</strong><br>
            <img id="cover" alt="No cover art">
            <br>
            <input type="file" id="coverInput" accept="image/*">
            <button id="removeCoverBtn">Remove Cover</button>
        </div><br>

        <button id="saveBtn">Save Changes</button>
    </div>

    <div id="loading" style="display:none; font-style:italic; color:gray; margin:10px 0;">
        Loading MP3 metadata…
    </div>
</main>

<footer>
<iframe src="/layout/footer.html" onload="this.insertAdjacentHTML('afterend', (this.contentDocument.body||this.contentDocument).innerHTML);this.remove()"></iframe>
</footer>


<script src="jsmediatags.min.js"></script>
<script src="browser-id3-writer.js"></script>
<script>
const fileInput      = document.getElementById("fileInput");
const tagInfo        = document.getElementById("tagInfo");
const tagList        = document.getElementById("tagList");
const addTagBtn      = document.getElementById("addTagBtn");
const cover          = document.getElementById("cover");
const coverInput     = document.getElementById("coverInput");
const removeCoverBtn = document.getElementById("removeCoverBtn");
const saveBtn        = document.getElementById("saveBtn");

let mp3File;
let arrayBuffer;
let newCover = null;
let removeCover = false;

// Map between jsmediatags keys and ID3v2 frame IDs
const keyToFrame = {
    title: 'TIT2',
    artist: 'TPE1',
    album: 'TALB',
    year: 'TYER',
    genre: 'TCON',
    comment: 'COMM',
    track: 'TRCK'
};

fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;

    document.getElementById("loading").style.display = "block"; // show loading

    mp3File = file;
    newCover = null;
    removeCover = false;
    tagList.innerHTML = "";

    const reader = new FileReader();
    reader.onload = function(ev) {
        arrayBuffer = ev.target.result;

        jsmediatags.read(file, {
            onSuccess: function(tag) {
                document.getElementById("loading").style.display = "none"; // hide loading
                const tags = tag.tags;

                // Render all found tags
                Object.keys(tags).forEach((key) => {
                if (key === "picture") return; // handled separately

                let value = tags[key];
                if (typeof value === "object" && value !== null) {
                    if ("text" in value) {
                        value = value.text; // handle comment-like objects
                    } else {
                        value = JSON.stringify(value); // fallback
                    }
                }
                addTagRow(key, value);
                });

                // Cover art
                if (tags.picture) {
                    const pic = tags.picture;
                    let base64String = "";
                    for (let i = 0; i < pic.data.length; i++) {
                        base64String += String.fromCharCode(pic.data[i]);
                    }
                    const base64 = btoa(base64String);
                    cover.src = `data:${pic.format};base64,${base64}`;
                } else {
                    cover.src = "";
                    cover.alt = "No cover art";
                }

                tagInfo.style.display = "block";
            },
            onError: function(err) {
                alert("Error reading tags: " + err.type);
            }
        });
    };
    reader.readAsArrayBuffer(file);
});

function addTagRow(key = "", value = "") {
    const row = document.createElement("div");
    row.className = "tag-row";

    // Decide whether to use input or textarea
    let valueField;
    if (typeof value === "string" && !value.startsWith("{") && !value.startsWith("[")) {
        valueField = `<input class="tag-value" placeholder="Value" value="${value.replace(/"/g, '&quot;')}">`;
    } else {
        valueField = `<textarea class="tag-value" placeholder="Value" rows="2" cols="40" style="resize: none;">${value}</textarea>`;
    }

    row.innerHTML = `
        <input class="tag-key" placeholder="Frame/Key" value="${key}">
        ${valueField}
        <button class="removeBtn">✖</button>
    `;
    row.querySelector(".removeBtn").onclick = () => row.remove();
    tagList.appendChild(row);
}

addTagBtn.addEventListener("click", () => addTagRow());

// Handle new cover upload
coverInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        const dataURL = ev.target.result;
        cover.src = dataURL;
        newCover = { dataURL, format: file.type };
        removeCover = false;
    };
    reader.readAsDataURL(file);
});

// Handle remove cover
removeCoverBtn.addEventListener("click", () => {
    cover.src = "";
    cover.alt = "No cover art";
    newCover = null;
    removeCover = true;
});

// Save changes
saveBtn.addEventListener("click", () => {
    if (!arrayBuffer) return alert("No MP3 loaded.");

    const writer = new ID3Writer(arrayBuffer);

    // Collect all tags from UI
    document.querySelectorAll(".tag-row").forEach(row => {
        const key = row.querySelector(".tag-key").value.trim();
        let value = row.querySelector(".tag-value").value.trim();
        if (!key || !value) return;

        const frame = keyToFrame[key.toLowerCase()] || key;

        // Try parsing JSON if it looks like an object
        try {
            if (value.startsWith("{") || value.startsWith("[")) {
                value = JSON.parse(value);
            }
        } catch (e) { /* ignore, keep as string */ }

        if (frame === "COMM") {
            writer.setFrame('COMM', { description: '', text: value });
        } else if (frame === "TPE1") {
            writer.setFrame(frame, [value]); // artist expects array
        } else {
            writer.setFrame(frame, value);
        }
    });

    // Cover art logic
    if (newCover) {
        const byteString = atob(newCover.dataURL.split(',')[1]);
        const byteArray = new Uint8Array(byteString.length);
        for (let i = 0; i < byteString.length; i++) {
            byteArray[i] = byteString.charCodeAt(i);
        }
        writer.setFrame('APIC', {
        type: 3,
        data: byteArray,
        description: "Cover",
        mimeType: newCover.format
        });
    } else if (removeCover) {
        // Skip APIC entirely
    }

    writer.addTag();

    const blob = writer.getBlob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "updated_" + mp3File.name;
    a.click();
    URL.revokeObjectURL(url);
});
</script>
</body>
</html>
