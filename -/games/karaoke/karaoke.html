<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Karaoke Layout</title>
<style>
/* @import url("https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;500;600;700;800;900;1000&family=Roboto:wght@300;400;500;700&display=swap"); */

*, *::before, *::after {
    box-sizing: border-box;
    padding: 0;
    margin: 0;
}

body {
    font-family: "Nunito", sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-image: url("bg1.png");
    /* background-color: hsl(234, 92%, 14%);
    background-image:
        radial-gradient( 650px circle at   0%   0%, #014d61 15%, transparent 100%),
        radial-gradient(1250px circle at 100% 100%, #014d61 15%, transparent 100%); */
    background-attachment: fixed;
    background-repeat: no-repeat;
    background-size: cover;
    overflow: hidden;
}

#container {
    width: 100%;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    /* background-color: hsl(234, 92%, 14%);
    background-image:
        radial-gradient( 650px circle at   0%   0%, #014d61 15%, transparent 100%),
        radial-gradient(1250px circle at 100% 100%, #014d61 15%, transparent 100%);
    background-repeat: no-repeat;
    background-attachment: fixed; */
    font-family: sans-serif, arial;
    overflow: hidden;
}

#screen {
    width: 100%;
    height: 100%;
    max-width: calc(100vh * (16 / 9));
    max-height: calc(100vw * (9 / 16));
    position: absolute;
    display: flex;
    font-size: calc(0.1 * max(10%, min(10vh * (16 / 9), 10vw)));
    overflow: hidden;
}

img {
    width: 100%;
}

h1 {
    font-size: clamp(1.2rem, 3vw, 1.5rem);
}

/* MAIN MENU */

main {
    display: flex;
    /* grid-template-columns: 25% 75%; */
    width: 95%;
    margin: 40px;
    background: rgba(16, 21, 61, 0.5);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 15px;
    box-shadow: 0 0.5px 0 1px rgba(255, 255, 255, 0.23) inset,
        0 1px 0 0 rgba(255, 255, 255, 0.6) inset, 0 4px 16px rgba(0, 0, 0, 0.12);
    z-index: 10;
}

/* LEFT CONTENT */

.left-content {
        padding: 30px 20px;
        color: #e5e5e5;
        /* width: 100%; */
        width: 30%;
        position: relative;
        display: block;
}

/* RIGHT CONTENT */

.right-content {
    display: grid;
    grid-template-rows: 86% 14%;
    border-radius: 0 15px 15px 0;
    border-left: 1px solid rgba(255, 255, 255, 0.5);
    padding: 30px 20px;
    color: #e5e5e5;
    width: 100%;
}

/* SONGS */

.recommended-songs h1 {
    margin-bottom: 24px;
}

.song-container {
    align-items: center;
    position: absolute;
    bottom: 0;
    height: 50%;
    width: 100%;
    overflow: hidden;
}

.song {
    display: grid;
    grid-template-columns: 40% 60%;
    align-items: start;
    margin: 16px 0;
    height: 3vw;
}

.song-img {
    position: relative;
    width: 60px;
    border-radius: 6px;
}

.song-img img {
    aspect-ratio: 4/3;
    border-radius: inherit;
    object-fit: cover;
    border: 2px solid rgba(159, 160, 168, 0.5);
    box-shadow: rgba(221, 221, 221, 0.3) 0px 6px 18px -3px,
        rgba(221, 221, 221, 0.2) 0px -3px 0px inset;
}

.song-img .overlay {
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    inset: 0;
    width: 100%;
    height: 92%;
    background-color: rgba(169, 150, 253, 0.6);
    border-radius: inherit;
    font-size: 1.75rem;
    opacity: 0;
    transition: all 0.4s linear;
    cursor: pointer;
}

.song-img:hover .overlay {
    opacity: 1;
}

.song h2 {
    font-size: 1rem;
}

.song p {
    font-size: 0.8rem;
    font-weight: 300;
}

.song span {
    font-size: 1.5rem;
    font-weight: 300;
}

.song p {
    opacity: 0.8;
}

/* MUSIC PLAYER */

.music-player {
        display: grid;
        position: relative;
        width: 100%;
        align-items: center;
        color: #FFC;
        background: rgba(188, 184, 198, 0.2);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: inset 2px -2px 6px rgba(214, 214, 214, 0.2), inset -3px 3px 3px rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 30px 20px;
        margin: 20px 0 30px 0;
}

.music-player h2 {
    font-size: 1.2rem;
    font-weight: 500;
    margin: 16px 0 2px;
}

.music-player p {
    font-size: 1rem;
    font-weight: 300;
    margin-bottom: 26px;
    opacity: 0.8;
}














.cdcase {
    position: relative;
    width: 100%;
    height: 100%;
    border: 1px solid #ccc;
    border-radius: inherit;
}

.cdcase::before {
    content: "";
    position: absolute;
    display: inline-block;
    width: 10%;
    height: 100%;
    border-right: 1px solid #ccc;
    background-color: #1e1e1e;
    background: #222;
    border-top-left-radius: inherit;
    border-bottom-left-radius: inherit;
}

.cdcase::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0%;
    width: 100%;
    height: 100%;
    background: radial-gradient(
        ellipse at 180% 110%,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.1) 74%,
        rgba(255, 255, 255, 0.2) 75%,
        rgba(255, 255, 255, 0.2) 100%
    );
    pointer-events: none;
    z-index: 2;
}

.cdcase > img {
    position: relative;
    width: 90%;
    height: 100%;
    float: right;
    border-top-right-radius: inherit;
    border-bottom-right-radius: inherit;
}

.cd {
    position: absolute;
    margin: auto;
    background: white;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 1px solid #dedede;
    box-shadow: 5px 10px 30px 1px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    width: 96%;
    height: 96%;
    top: 2%;
    animation: spin 3s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.cd {
    left: 48%;
    z-index: -1;
}

.cd > img {
    position: absolute;
    width: 100%;
    height: 100%;
}

.cd::before {
    height: 100%;
    width: 100%;
    border-radius: 50%;
    background: conic-gradient(
        from 0deg,
        #dcdcdc 0deg,
        #f5f5f5 40deg,
        #dcdcdc 80deg,
        rgba(255, 0, 0, 0.4) 90deg,
        rgba(255, 255, 0, 0.3) 100deg,
        rgba(0, 255, 255, 0.3) 110deg,
        #e0e0e0 140deg,
        #dcdcdc 180deg,
        #e6e6e6 260deg, /**/
        rgba(255, 0, 0, 0.4) 270deg,
        rgba(255, 255, 0, 0.3) 280deg,
        rgba(0, 255, 255, 0.3) 290deg,
        /* #e6e6e6 270deg, */
        #f0f0f0 300deg,
        #dcdcdc 360deg
    );
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    z-index: 1;
    content: "";
}

.cd::after {
    position: absolute;
    height: 12.5%;
    width: 12.5%;
    /* background: white; */
    background: #0d5499;
    border-radius: 50%;
    box-shadow: inset 2px 4px 10px 0px rgba(0, 0, 0, 0.3);
    z-index: 1;
    content: "";
}

#cdcontent, #albumArt       
{
    font-size: .75em;
    width: 100%;
    text-align: left;
    margin: 0px auto;
    border: 1px solid #CCC;
    border-radius: 8px;
    /* padding: 1em; */

    position: relative;
    width: 12.5vw;
    height: 12.5vw;
    left: -15%;
    background: black;
    background-size: cover;
    background-position: center;
    z-index: 1;
}






#overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10;
}

#start {
    padding: 20px 40px;
    font-size: 24px;
    cursor: pointer;
}




svg {
    width: 200px;
    height: 200px;
}

#countdownWrap {
    position: absolute;
    inset: 0;
    display: none;
    place-items: center;
    background: rgba(0,0,0,0.5);
    z-index: 10;
}

#countdownSvg {
    width: 220px;
    height: 220px;
    transform: rotate(-90deg);
}

#countdownSvg circle.bg {
    stroke: #3a3a3a;
    stroke-width: 12;
    fill: none;
}

#countdownSvg circle.fg {
    stroke: #1976D2;
    stroke-width: 12;
    fill: none;
    stroke-dasharray: 628;
    stroke-dashoffset: 628;
}

#countLabel {
    position: absolute;
    font-size: 72px;
    font-weight: 800;
    letter-spacing: 2px;
    color: #fffb;
}





#gameArea {
    position: absolute;
    width: 60%;
    right: 5%;
    top: 10%;
    height: 60%;
    margin: 0 auto;
    overflow-y: auto;
    border-top: 2px solid #666;
    border-left: 2px solid #666;
    border-right: 2px solid #666;
    background: rgba(34, 34, 34, 0.5);
    overflow: hidden;
}

#P1Notes, #notesCanvas {
    position: relative;
    width: 100%;
    height: 100%;
}

#lyricsArea {
    position: absolute;
    width: 75%;
    right: 0%;
    /* top: 70%; */
    bottom: 0;
    height: 14%;
    margin: 0 auto;
    overflow-y: auto;
    background: #00000000;
    background: linear-gradient(90deg,
        rgba(0, 0, 0, 0) 0%,
        rgba(0, 0, 0, 0.45) 10%,
        rgba(0, 0, 0, 0.45) 90%,
        rgba(0, 0, 0, 0) 100%);
    overflow: hidden;
}

.karaoke__lyrics-container {
    position: absolute;
    width: 100%;
    height: 100%;
    bottom: 0;
    margin: 0 auto;
    /* overflow: hidden; */
}

.karaoke__lyrics {
  position: relative;
  height: 8.5rem;       /* enough room for 2 lines */
  overflow: hidden;   /* hide offscreen lines */
}

.karaoke__lyrics-item {
  position: absolute;
  width: 100%;
  left: 0;
  text-align: center;
  font-size: 2rem;
  opacity: 0;
  transform: translateY(100%); /* default: below */
  transition: transform 0.6s ease, opacity 0.6s ease, font-size 0.6s ease;
}

.karaoke__lyrics-item.current {
  transform: translateY(0);    /* center slot */
  opacity: 1;
  color: yellow;
  font-size: 3.5rem;
    line-height: 80px;
}

.karaoke__lyrics-item.next {
  transform: translateY(100%); /* below */
  opacity: 0.7;
  top: 48px;
}

.karaoke__lyrics-item.past {
  transform: translateY(-100%); /* above */
  opacity: 0;
}


#lyrics {
    position: absolute;
    bottom: 5%;
    width: 100%;
    text-align: center;
    font-size: 28px;
    list-style: none;
    margin: 0;
    padding: 0;
}

#lyrics li {
    /* opacity: 0.5;
    line-height: 1.5; */
    font-size: 2rem;
    color: #8c8c8c;
    padding: 0.75rem 4rem;
    list-style: none;
}

#lyrics li.active {
    /* opacity: 1;
    font-size: 48px;
    font-weight: bold;
    color: yellow;
    line-height: 80px; */
    transition: color 0.2s, font-size 0.4s linear;
    color: yellow;
    font-size: 2.5rem;
    font-weight: bold;
}


#P1, #P2 {
    position: relative;
    width: 100%;
    height: 50%;
}

/* #P1 { background-color: red;  }
#P2 { background-color: blue; } */

#P1.solo { top: 25%; }
#P1.solo + canvas { height: 0; }
</style>
</head>
<body>

<div id="container">
    <div id="screen">

<main>
    <div class="left-content">
        <div class="music-player">
            <!-- <div class="album-cover">
                <img src="images/album-cover.png" id="rotatingImage" alt="" />
            </div> -->

            <div id="cdcontent">
                <div class="cdcase">
                    <img id="cdcover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw">
                    <div class="cd">
                        <img src="">
                    </div>
                </div>
            </div>

            <h2>Title</h2>
            <p>Artist</p>

            <audio id="audio"></audio>
        </div>

        <div class="recommended-songs">
            <h1>Next Up</h1>
            <div class="song-container">
                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>

                <div class="song">
                    <span>Singer</span>
                    <div class="song-title">
                        <h2>Title</h2>
                        <p>Artist</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-content">
        <div class="slider-container">
            <!-- <canvas id="P1Notes"></canvas> -->
            <canvas id="P1Notes" class="solo"></canvas>
            <canvas id="P2Notes"></canvas>
        </div>

        <div id="lyricsArea">
            <div class="karaoke__lyrics-container">
                <ul class="karaoke__lyrics"></ul>
            </div>
        </div>
    </div>
</main>

    </div>
</div>

<div style="position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 12000;">
    <input type="file" id="file-upload" accept="audio/*" style="display:none;">
    <div id="overlay">
        <button id="start">START</button>
    </div>

    <!-- Countdown overlay -->
    <div id="countdownWrap">
        <svg id="countdownSvg" viewBox="0 0 220 220" aria-hidden="true">
            <circle class="bg" cx="110" cy="110" r="100"></circle>
            <circle class="fg" cx="110" cy="110" r="100"></circle>
        </svg>
        <div id="countLabel">3</div>
    </div>
</div>

<canvas id="visualizerCanvas" style="position: absolute; bottom: 0;"></canvas>

<script src="jsmediatags.min.js"></script>
<script>

/* ======== GLOBALS ======== */
const urlParams = new URLSearchParams(window.location.search);
const singmode = urlParams.get('singmode') || 'solo';
const song     = "songs/" + urlParams.get('song');

window.noteData = [];
window.lyricsData = [];
window.BPM = 0;
window.START = 0;

var jsmediatags = window.jsmediatags;

const startBtn = document.getElementById("start");
const overlay = document.getElementById("overlay");
const fileUpload = document.getElementById("file-upload");
const audioEl = document.getElementById("audio");
// const lyricsContainer = document.getElementById("lyrics");
const lyricsContainer = document.querySelector(".karaoke__lyrics");
const svgLoader = document.getElementById("svgLoader");
const progressCircle = document.getElementById("progressCircle");
const visualizerCanvas = document.getElementById("visualizerCanvas");
const P1Notes = document.getElementById("P1Notes");

let audioCtx, analyser, dataArray, bufferLength;
let sourceNode;
let karaokeStarted = false;

/* ======== START FLOW ======== */
startBtn.addEventListener("click", () => {
    if (!audioEl.src) {
        fileUpload.click(); // wait for file selection
    } else {
        // beginCountdown();
        runCountdown(10, () => startKaraoke());
    }
});

function parseSingStarLyrics(rawLyrics) {
    const lines = rawLyrics.split("\n");
    const bpmRegex   =   /^#BPM:\s*(\d+(\.\d+)?)/;
    const startRegex = /^#GAP:\s*(\d+(\.\d+)?)/;

    for (let line of lines) {
        line = line.replace(/\r$/, ""); // Just remove carriage returns if present, keep spaces intact

        if (line === "") continue;

        if (line.startsWith("#BPM")) {
            const match = line.match(bpmRegex);
            if (match) {
                const bpmValue = parseFloat(match[1]);
                if (!isNaN(bpmValue)) {
                    window.BPM = bpmValue;
                }
            }
            continue;
        }

        if (line.startsWith("#GAP")) {
            const match = line.match(startRegex);
            if (match) {
                const startValue = parseFloat(match[1]);
                if (!isNaN(startValue)) {
                    // window.START = (startValue / 1000) - 14; // 14 sec ripped from song - Just the way you are
                    window.START = startValue / 1000;
                }
            }
            continue;
        }

        const parts = line.split(" ");
        const type = parts[0];

        if (!["*", ":", "F", "-", "E", "R", "G"].includes(type)) continue;

        if (type === "E") {
            window.noteData.push({ type: "E" });
            continue;
        }

        // For the "-" note type, sometimes there might not be the 4 values,
        // so push it directly with empty or zero fields if parts are missing
        if (type === "-") {
            window.noteData.push({
                type: "-",
                start: 0,
                end: 0,
                midi: 0,
                text: ""
            });
            continue;
        }

        if (parts.length < 4) continue;

        const beatStart = parseInt(parts[1]);
        const beatLength = parseInt(parts[1]) + parseInt(parts[2]);
        const pitch = parseInt(parts[3]) + 60;
        const text = parts.slice(4).join(" ") || "";

        if (isNaN(beatStart) || isNaN(beatLength) || isNaN(pitch)) continue;

        const beatDuration = 60 / window.BPM / 4; // 4 is used by UltraStart

        window.noteData.push({
            type: type,
            start: parseFloat((window.START + beatStart * beatDuration).toFixed(3)), // add START offset
            // length: parseFloat((beatLength * beatDuration).toFixed(3)),
            end: parseFloat((window.START + beatLength * beatDuration).toFixed(3)),
            midi: pitch,
            text: text
        });
    }
}

function renderLyricsFromParsedData() {
    // const container = document.getElementById("lyrics");
    lyricsContainer.innerHTML = "";
    window.lyricsData = [];

    let currentLine = document.createElement("li");
    let lineStart = null;
    let lineText = "";
    let lineLastNoteEnd = null; // track last note's end in this line

    const pushLine = (endTime) => {
        if (currentLine.childNodes.length > 0) {
            window.lyricsData.push({
                start: lineStart !== null ? lineStart : 0,
                end: endTime !== null ? endTime : (lineLastNoteEnd !== null ? lineLastNoteEnd : lineStart),
                text: lineText.trim()
            });
            currentLine.className = "karaoke__lyrics-item";
            lyricsContainer.appendChild(currentLine);
        }
    };

    for (let i = 0; i < window.noteData.length; i++) {
        const note = window.noteData[i];

        switch (note.type) {
            case "E":
                break;

            case "-": {
                // end of line: next note start or last note end
                const nextNote = window.noteData[i + 1];
                let nextStart = nextNote ? nextNote.start : null;
                pushLine(nextStart);
                
                // reset for next line
                currentLine = document.createElement("li");
                lineStart = null;
                lineText = "";
                lineLastNoteEnd = null;
                break;
            }

            case "*":
            case "F":
            case "R":
            case "G":
            case ":":
                {
                    let textToUse = note.text || "";
                    if (textToUse.startsWith("~")) textToUse = textToUse.slice(1);
                    const endsWithSpace = (note.text || "").endsWith(" ");

                    const span = document.createElement("span");
                    span.textContent = textToUse + (endsWithSpace ? " " : "");

                    if (note.type === "*") span.style.fontWeight = "bold";
                    if (note.type === "F") span.style.fontStyle = "italic";

                    currentLine.appendChild(span);

                    if (lineStart === null) lineStart = note.start;
                    lineText += textToUse + (endsWithSpace ? " " : "");

                    // track end of last note in line
                    lineLastNoteEnd = note.start + (note.length || 0);
                }
                break;

            default:
                break;
        }
    }

    // push final line
    if (currentLine.childNodes.length > 0) {
        pushLine(null); // will fallback to last note end
    }

    // ===== Add extra end-of-song line =====
    const lastEndTime = window.lyricsData.length
        ? window.lyricsData[window.lyricsData.length - 1].end
        : 0;

    const endLine = document.createElement("li");
    endLine.textContent = "---";
    endLine.className = "karaoke__lyrics-item";
    lyricsContainer.appendChild(endLine);

    window.lyricsData.push({
        start: lastEndTime,
        end: lastEndTime + 12000, // display for 12000 seconds to prevent it from disappering
        text: "---"
    });
}

fileUpload.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) {
        audioEl.src = URL.createObjectURL(file);

        new jsmediatags.Reader(file)
        .setTagsToRead(["TALB", "TPE1", "TBPM", "COMM", "TCON", "GRP1", "TIT2", "TRCK", "USLT", "TYER", "APIC", "TXXX"])
        .read({
            onSuccess: function (tag) {
                //console.log(tag.tags.comment);
                //console.log(tag.tags.lyrics);
                if ( undefined === tag.tags.picture ) {
                    console.log("no picture");
                }
                else {
                    const { data, format } = tag.tags.picture;
                    let base64String = "";
                    for (var i = 0; i < data.length; i++) {
                        base64String += String.fromCharCode(data[i]);
                    }
                    document.getElementById("cdcover").src = `data:${
                        data.format
                    };base64,${window.btoa(base64String)}`;
                    tag.tags.picture = "";
                    tag.tags.APIC = "";          
                }

                if (Array.isArray(tag.tags.TXXX)) {
                    var numOfSingers;
                    if (singmode == "solo") { numOfSingers = 0; }
                    if (singmode == "duet") { numOfSingers = 1; }
                    parseSingStarLyrics(tag.tags.TXXX[numOfSingers].data.data);
                } else {
                    parseSingStarLyrics(tag.tags.TXXX.data.data);
                }
                renderLyricsFromParsedData();

                // remvoe the "-" lines to fix the notes
                window.noteData = window.noteData.filter(note => note.type !== '-');

                console.log(JSON.stringify(tag, null, 4));
            },
            onError: function (error) {
                console.log(":(", error.type, error.info);
            }
        });

        runCountdown(10, () => startKaraoke());
    }
});

/* ======== COUNTDOWN ======== */
const countdownWrap = document.getElementById('countdownWrap');
const countdownSvg  = document.getElementById('countdownSvg');
const fgCircle      = countdownSvg.querySelector('circle.fg');
const countLabel    = document.getElementById('countLabel');

function runCountdown(seconds, done) {
    overlay.style.opacity = 0;

    const CIRC = 2 * Math.PI * 100; // r=100
    fgCircle.style.strokeDasharray = CIRC;
    countdownWrap.style.display = 'grid';

    let remaining = seconds;
    countLabel.textContent = remaining;

    const start = performance.now();
    function tick(now) {
        const elapsed = (now - start) / 1000;
        const p = Math.min(elapsed / seconds, 1);
        fgCircle.style.strokeDashoffset = String(CIRC * (1 - p));
        const next = Math.ceil(seconds - elapsed);
        if (next !== remaining && next >= 0) {
            remaining = next;
            countLabel.textContent = remaining || 'Go!';
        }
        if (p < 1) requestAnimationFrame(tick);
        else {
            countdownWrap.style.display = 'none';
            done();
        }
    }
    requestAnimationFrame(tick);
}

/* ======== KARAOKE START ======== */
function startKaraoke() {
    
    if (karaokeStarted) return;

    karaokeStarted = true;

    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }

    sourceNode = audioCtx.createMediaElementSource(audioEl);
    analyser = audioCtx.createAnalyser();
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);

    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    startTime = audioCtx.currentTime;
    audioEl.play();
    requestAnimationFrame(drawVisualizer);
    // requestAnimationFrame(drawPitch);
    requestAnimationFrame(update);
    requestAnimationFrame(updateLyrics);
}

/* ======== VISUALIZER ======== */
function drawVisualizer() {
    if (!karaokeStarted) return;
    const ctx = visualizerCanvas.getContext("2d");
    visualizerCanvas.width = window.innerWidth;
    visualizerCanvas.height = window.innerHeight;

    analyser.getByteFrequencyData(dataArray);
    ctx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

    let barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
    let x = 0;
    dataArray.forEach((v) => {
        let barHeight = v;
        ctx.fillStyle = "rgba(" + (v+100) + "," + (v+100) + "," + (v+100) +", 0.3)";
        ctx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
        x += barWidth + 1;
    });

    requestAnimationFrame(drawVisualizer);
}

/* ======== PITCH DETECTION ======== */
const ctx = P1Notes.getContext("2d");
function drawPitch() {
    if (!karaokeStarted) return;
    // const ctx = P1Notes.getContext("2d");
    P1Notes.width = window.innerWidth;
    P1Notes.height = window.innerHeight;

    let buffer = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buffer);
    let pitch = autoCorrelate(buffer, audioCtx.sampleRate);

    ctx.clearRect(0, 0, P1Notes.width, P1Notes.height);
    if (pitch !== -1) {
        ctx.fillStyle = "#0f0";
        ctx.fillText("Pitch: " + Math.round(pitch) + " Hz", 50, 50);
    }

    requestAnimationFrame(drawPitch);
}

let startTime = 0;
let pitchHistory = [];
const pixelsPerSecond = 120; // horizontal speed
const noteHeight = 10;       // pixels per semitone
const centerMidi = 60;       // middle C centerline
const hitTolerance = 50;     // cents tolerance for hit

function drawRoundedRect(ctx, x, y, w, h, r) {
    // snap everything to nearest half-pixel to avoid blurry lines
    x = Math.round(x) + 0.5;
    y = Math.round(y) + 0.5;
    w = Math.round(w);
    h = Math.round(h);
    r = Math.min(r, w / 2, h / 2); // prevent radius > size

    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
}

function update() {
    const now = audioCtx.currentTime - startTime;

    ctx.clearRect(0, 0, P1Notes.width, P1Notes.height);

    // Draw all target notes
    for (const n of window.noteData) {
        const noteAdj = 5;
        const x = (n.start - now) * pixelsPerSecond + P1Notes.width/2;
        const w = (n.end - n.start) * pixelsPerSecond;
        const y = (centerMidi - n.midi) * noteHeight + P1Notes.height/2;

        // pick fill color
        let fillColor = "rgba(192,192,192,0.4)"; // default gray
        if (n.type === "*" || n.type === "G") {
            fillColor = "rgba(255,215,0,0.8)"; // gold
        }

        ctx.fillStyle = fillColor;
        drawRoundedRect(ctx, x, y, w + noteAdj, noteHeight + noteAdj, (noteHeight + noteAdj)/2);
        ctx.fill();

        ctx.strokeStyle = "black";
        ctx.lineWidth = 1; // crisp border
        ctx.stroke();
    }

    // Draw current detected pitch
    let buffer = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buffer);
    let freq = autoCorrelate(buffer, audioCtx.sampleRate);
    if (freq > 0) {
        const midi = 69 + 12 * Math.log2(freq / 440);
        const y = (centerMidi - midi) * noteHeight + P1Notes.height/2;
        ctx.fillStyle = "lime";
        ctx.fillRect(P1Notes.width/2 - 2, y, 4, noteHeight);
    }

    // Draw center "hit" line
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(P1Notes.width/2, 0);
    ctx.lineTo(P1Notes.width/2, P1Notes.height);
    ctx.stroke();

    requestAnimationFrame(update);
}

function resizeCanvas() {
  const dpr = window.devicePixelRatio || 1; // high-DPI screens
  const rect = P1Notes.getBoundingClientRect();

  P1Notes.width  = rect.width * dpr;
  P1Notes.height = rect.height * dpr;

  ctx.setTransform(1, 0, 0, 1, 0, 0); // reset any transforms
  ctx.scale(dpr, dpr); // scale so drawing uses CSS pixels
}

window.addEventListener("resize", resizeCanvas);
resizeCanvas(); // call once at start


function freqToNearestNote(midi) {
  return 440*Math.pow(2,(midi-69)/12);
}

function draw(now, currentMidi, hit) {
  ctx.clearRect(0,0,P1Notes.width,P1Notes.height);
  const midY = P1Notes.height/2;

  // Draw target notes
  ctx.lineWidth = noteHeight;
  for (const n of song) {
    const xStart = P1Notes.width/2 + (n.start - now)*pixelsPerSecond;
    const xEnd   = P1Notes.width/2 + (n.end   - now)*pixelsPerSecond;
    const y = midY - (n.midi - centerMidi)*noteHeight;
    ctx.strokeStyle = "#444";
    ctx.beginPath();
    ctx.moveTo(xStart,y);
    ctx.lineTo(xEnd,y);
    ctx.stroke();
  }

  // Draw pitch trail
  ctx.strokeStyle = "#0f0";
  ctx.beginPath();
  pitchHistory.forEach((p,i)=>{
    const x = P1Notes.width/2 + (p.time-now)*pixelsPerSecond;
    const y = midY - (p.midi-centerMidi)*noteHeight;
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // Playhead line
  ctx.strokeStyle = hit?"#ff0":"#f00";
  ctx.beginPath();
  ctx.moveTo(P1Notes.width/2,0);
  ctx.lineTo(P1Notes.width/2,P1Notes.height);
  ctx.stroke();
}

function autoCorrelate(buf, sampleRate) {
    let SIZE = buf.length;
    let MAX_SAMPLES = Math.floor(SIZE/2);
    let best_offset = -1;
    let best_correlation = 0;
    let rms = 0;
    for (let i=0;i<SIZE;i++) {
        let val = buf[i];
        rms += val*val;
    }
    rms = Math.sqrt(rms/SIZE);
    if (rms<0.01) return -1;
    let lastCorrelation=1;
    for (let offset = 0; offset < MAX_SAMPLES; offset++) {
        let correlation=0;
        for (let i=0; i<MAX_SAMPLES; i++) {
            correlation += Math.abs((buf[i])-(buf[i+offset]));
        }
        correlation = 1 - (correlation/MAX_SAMPLES);
        if ((correlation>0.9)&&(correlation>lastCorrelation)) {
            best_correlation=correlation; best_offset=offset;
        }
        lastCorrelation=correlation;
    }
    if (best_correlation>0.01) {
        let fundamentalFreq = sampleRate/best_offset;
        return fundamentalFreq;
    }
    return -1;
}

/* ======== LYRICS SCROLL ======== */
let currentIndex = -1;

function updateLyrics() {
  if (!karaokeStarted) return;

  const now = audioEl.currentTime;
  const lines = lyricsContainer.querySelectorAll("li");

  // find the active line index
  let newIndex = -1;
  for (let i = 0; i < window.lyricsData.length; i++) {
    const line = window.lyricsData[i];
    if (now >= line.start && now <= line.end) {
      newIndex = i;
      break;
    }
  }

  if (newIndex !== currentIndex) {
    currentIndex = newIndex;

    lines.forEach((line, i) => {
      line.classList.remove("current", "next", "past");
      if (i === currentIndex) {
        line.classList.add("current");
      } else if (i === currentIndex + 1) {
        line.classList.add("next");
      } else if (i < currentIndex) {
        line.classList.add("past");
      }
    });
  }

  requestAnimationFrame(updateLyrics);
}



</script>
</body>
</html>