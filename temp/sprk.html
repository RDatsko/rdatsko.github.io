<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SPRK+ Battery Test</title>
</head>
<body>
  <button id="scan">Connect to SPRK+</button>
  <pre id="output"></pre>

  <script>
    const button = document.getElementById('scan');
    const output = document.getElementById('output');
    const log = (...args) => output.textContent += args.join(' ') + '\n';

    const BATTERY_CHAR = '22bb746f-2bb8-7554-2d6f-726568705327';
    const CMD_SERVICE  = '22bb746f-2ba0-7554-2d6f-726568705327';
    const CMD_CHAR     = '22bb746f-2ba1-7554-2d6f-726568705327';
    const ASYNC_CHAR   = '22bb746f-2ba6-7554-2d6f-726568705327';

    button.addEventListener('click', async () => {
      output.textContent = '';

      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'SK' }],
          optionalServices: [
            '0000180a-0000-1000-8000-00805f9b34fb',
            '00001016-d102-11e1-9b23-00025b00a5a5',
            '22bb746f-2bb0-7554-2d6f-726568705327',
            '22bb746f-2ba0-7554-2d6f-726568705327'
          ]
        });

        log('Selected:', device.name);
        const server = await device.gatt.connect();
        log('Connected');

        // ðŸ”‹ Read battery
        const battService = await server.getPrimaryService('22bb746f-2bb0-7554-2d6f-726568705327');
        const battChar = await battService.getCharacteristic(BATTERY_CHAR);
        const value = await battChar.readValue();
        const batteryPct = value.getUint8(0);
        log('Battery Level:', batteryPct, '%');

        // ðŸ“¡ Subscribe to async notifications
        const cmdService = await server.getPrimaryService(CMD_SERVICE);
        const asyncChar = await cmdService.getCharacteristic(ASYNC_CHAR);
        await asyncChar.startNotifications();
        asyncChar.addEventListener('characteristicvaluechanged', (event) => {
          const data = new Uint8Array(event.target.value.buffer);
          log('Async notification:', Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' '));
        });
        log('Listening for async notifications...');

      } catch (err) {
        log('Error:', err);
      }
    });
  </script>
</body>
</html>
