<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sphero BLE Dashboard</title>
<style>
  body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
  h1 { color: #333; }
  .status { margin-top: 10px; padding: 10px; background: #fff; border-radius: 5px; }
  .log { margin-top: 10px; padding: 10px; background: #222; color: #0f0; height: 200px; overflow-y: auto; white-space: pre-wrap; font-family: monospace;}
  button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>

<h1>Sphero BLE Dashboard</h1>

<button id="connectBtn">Connect to Sphero</button>

<div class="status" id="status">Status: Not connected</div>
<div class="status" id="battery">Battery: N/A</div>
<div class="status" id="led">LED: N/A</div>
<div class="status" id="orientation">Orientation: N/A</div>
<div class="status" id="velocity">Velocity: N/A</div>

<div class="log" id="log"></div>

<script>
// const logEl = document.getElementById('log');
// function log(msg) {
//   logEl.textContent += msg + '\n';
//   logEl.scrollTop = logEl.scrollHeight;
// }

// // Sphero SK service UUIDs
// const SPP_SERVICE = '22bb746f-2bb0-7554-2d6f-726568705327';
// const IMU_SERVICE = '22bb746f-2ba0-7554-2d6f-726568705327';
// const BATTERY_CHAR = '22bb746f-2bb2-7554-2d6f-726568705327';
// const LED_CHAR = '22bb746f-2bb4-7554-2d6f-726568705327';
// const IMU_ORIENTATION_CHAR = '22bb746f-2ba3-7554-2d6f-726568705327';
// const IMU_VELOCITY_CHAR = '22bb746f-2ba5-7554-2d6f-726568705327';
// const IMU_STREAM_CONFIG_CHAR = '22bb746f-2ba1-7554-2d6f-726568705327';

// async function connectSphero() {
//   try {
//     document.getElementById('status').textContent = 'Status: Scanning for devices...';

//     const device = await navigator.bluetooth.requestDevice({
//       filters: [{ namePrefix: 'SK-' }],
//       optionalServices: [SPP_SERVICE, IMU_SERVICE]
//     });

//     log(`✅ Found device: ${device.name} (${device.id})`);
//     document.getElementById('status').textContent = 'Status: Connecting...';

//     const server = await device.gatt.connect();
//     document.getElementById('status').textContent = 'Status: Connected';

    

    // -------------------
    // BATTERY
    // -------------------
    // const mainService = await server.getPrimaryService(SPP_SERVICE);
    // const batteryChar = await mainService.getCharacteristic(BATTERY_CHAR);
    // const batteryValue = await batteryChar.readValue();
    // const batteryPercent = batteryValue.getUint8(0);
    // document.getElementById('battery').textContent = `Battery: ${batteryPercent}%`;
    // log(`Battery level: ${batteryPercent}%`);

    // -------------------
    // LED
    // -------------------
    // const ledChar = await mainService.getCharacteristic(LED_CHAR);
    // const r = 0, g = 128, b = 255; // Blue
    // // Proper Sphero LED packet: [0xFF, R, G, B, 0x00] works on SK
    // await ledChar.writeValue(new Uint8Array([0xFF, r, g, b, 0x00]));
    // document.getElementById('led').textContent = `LED: RGB(${r}, ${g}, ${b})`;
    // log(`LED color set to RGB(${r},${g},${b})`);

    // -------------------
    // IMU (Orientation & Velocity)
    // -------------------
    // const imuService = await server.getPrimaryService(IMU_SERVICE);
    // const imuConfigChar = await imuService.getCharacteristic(IMU_STREAM_CONFIG_CHAR);
    // const orientationChar = await imuService.getCharacteristic(IMU_ORIENTATION_CHAR);
    // const velocityChar = await imuService.getCharacteristic(IMU_VELOCITY_CHAR);

    // // Enable streaming: configure IMU (example: 50Hz, all data)
    // const enableStreamPacket = new Uint8Array([0x01, 0x64, 0xFF, 0xFF]); // streamRate=100ms (10Hz), all sensors
    // await imuConfigChar.writeValue(enableStreamPacket);

    // await orientationChar.startNotifications();
    // orientationChar.addEventListener('characteristicvaluechanged', (event) => {
    //   const value = event.target.value;
    //   const qx = value.getInt16(0, true) / 16384.0;
    //   const qy = value.getInt16(2, true) / 16384.0;
    //   const qz = value.getInt16(4, true) / 16384.0;
    //   const qw = value.getInt16(6, true) / 16384.0;
    //   document.getElementById('orientation').textContent = 
    //     `Orientation (quat): qx:${qx.toFixed(3)}, qy:${qy.toFixed(3)}, qz:${qz.toFixed(3)}, qw:${qw.toFixed(3)}`;
    // });

    // await velocityChar.startNotifications();
    // velocityChar.addEventListener('characteristicvaluechanged', (event) => {
    //   const value = event.target.value;
    //   const vx = value.getInt16(0, true) / 1000;
    //   const vy = value.getInt16(2, true) / 1000;
    //   const vz = value.getInt16(4, true) / 1000;
    //   document.getElementById('velocity').textContent = 
    //     `Velocity: vx:${vx.toFixed(3)}, vy:${vy.toFixed(3)}, vz:${vz.toFixed(3)}`;
    // });

    // log('Orientation & velocity streaming enabled.');



//   } catch (error) {
//     document.getElementById('status').textContent = 'Status: Error';
//     log(`❌ Error: ${error}`);
//   }
// }

// document.getElementById('connectBtn').addEventListener('click', connectSphero);




    const button = document.getElementById('scan');
    const output = document.getElementById('log');

    function log(...args) {
      output.textContent += args.join(' ') + '\n';
    }

    button.addEventListener('click', async () => {
      output.textContent = ''; // clear

      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { namePrefix: 'SK' },    // many SPRK+ devices have names like "SK-xxxx"
            // { name: 'SPRK+' }      // sometimes direct name works
          ],
          optionalServices: [
            /* include candidate services you suspect or want to try:
               - standard services, e.g. device_information (0x180A)
               - battery_service (0x180F)
               - generic_access / generic_attribute
               - any custom ones you know or find
            */
            'device_information',
            'battery_service',
            // Custom candidate service UUIDs (if you want to test these)
            '22bb746f-2ba0-7554-2d6f-726568705327',
            '22bb746f-2bb0-7554-2d6f-726568705327',
            '00001016-d102-11e1-9b23-00025b00a5a5'
          ]
        });

        log('Selected device:', device.name || 'Unnamed', 'ID:', device.id);

        const server = await device.gatt.connect();
        log('Connected:', server.connected);

        const services = await server.getPrimaryServices();
        log('Services found:', services.length);

        for (const service of services) {
          log('---');
          log('Service UUID:', service.uuid);

          let chars;
          try {
            chars = await service.getCharacteristics();
          } catch (err) {
            log('  Could not get characteristics for this service:', err);
            continue;
          }

          for (const char of chars) {
            log('  Characteristic UUID:', char.uuid);
            log('    Properties:', JSON.stringify(char.properties));

            // Try read if readable
            if (char.properties.read) {
              try {
                const value = await char.readValue();
                // Convert value to hex or numbers
                const arr = [];
                for (let i = 0; i < value.byteLength; i++) {
                  arr.push(value.getUint8(i));
                }
                log('    Read value:', arr.map(b => b.toString(16).padStart(2, '0')).join(' '));
              } catch (err) {
                log('    Read error:', err);
              }
            }

            // Try notifications if supported
            if (char.properties.notify || char.properties.indicate) {
              try {
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (event) => {
                  const evVal = event.target.value;
                  const arr2 = [];
                  for (let i = 0; i < evVal.byteLength; i++) {
                    arr2.push(evVal.getUint8(i));
                  }
                  log('    Notification from', char.uuid, ':', arr2.map(b => b.toString(16).padStart(2, '0')).join(' '));
                });
                log('    Notifications started for', char.uuid);
              } catch (err) {
                log('    Notification error:', err);
              }
            }
          }
        }

      } catch (error) {
        log('Error:', error);
      }
    });
</script>

</body>
</html>
