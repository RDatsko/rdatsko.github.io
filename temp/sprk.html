<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sphero SK Controller</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { margin: 5px; }
    #log { white-space: pre-wrap; margin-top: 20px; background: #f0f0f0; padding: 10px; }
  </style>
</head>
<body>
  <h1>Sphero SK Controller</h1>
  <button id="connect">Connect to Sphero</button>
  <br>
  <label>LED Color:</label>
  <input type="color" id="ledColor" value="#00ff00">
  <button id="setLED">Set LED</button>
  <p id="battery">Battery: --</p>
  <p id="orientation">Orientation: --</p>
  <div id="log"></div>

  <script>
    let device;
    let server;
    let mainService;
    let batteryChar;
    let imuService;
    let imuChar;

    const logDiv = document.getElementById('log');
    function log(msg) {
      console.log(msg);
      logDiv.textContent += msg + "\n";
    }

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        log('Requesting Sphero device...');
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'SK' }],
          optionalServices: [
            '22bb746f-2bb0-7554-2d6f-726568705327', // Main service (LED, battery)
            '22bb746f-2ba0-7554-2d6f-726568705327'  // IMU service (orientation)
          ]
        });

        log(`✅ Found device: ${device.name} (${device.id})`);
        server = await device.gatt.connect();
        log('Connected to GATT server');

        // Main Sphero service
        mainService = await server.getPrimaryService('22bb746f-2bb0-7554-2d6f-726568705327');

        // Battery characteristic
        batteryChar = await mainService.getCharacteristic('22bb746f-2bb2-7554-2d6f-726568705327');
        const batteryValue = await batteryChar.readValue();
        const batteryPercent = batteryValue.getUint8(0);
        document.getElementById('battery').textContent = `Battery: ${batteryPercent}%`;
        log(`Battery level: ${batteryPercent}%`);

        // IMU Service for orientation
        imuService = await server.getPrimaryService('22bb746f-2ba0-7554-2d6f-726568705327');
        imuChar = await imuService.getCharacteristic('22bb746f-2ba1-7554-2d6f-726568705327');

        await imuChar.startNotifications();
        imuChar.addEventListener('characteristicvaluechanged', (event) => {
          const data = event.target.value;
          // Sphero orientation format: 6 bytes (x, y, z) int16
          const x = data.getInt16(0, true);
          const y = data.getInt16(2, true);
          const z = data.getInt16(4, true);
          document.getElementById('orientation').textContent = `Orientation: x=${x}, y=${y}, z=${z}`;
        });

        log('Orientation notifications started');

      } catch (error) {
        log(`❌ Error: ${error}`);
      }
    });

    // LED control
    document.getElementById('setLED').addEventListener('click', async () => {
      if (!mainService) return;
      const color = document.getElementById('ledColor').value;
      const r = parseInt(color.slice(1,3), 16);
      const g = parseInt(color.slice(3,5), 16);
      const b = parseInt(color.slice(5,7), 16);

      try {
        const ledChar = await mainService.getCharacteristic('22bb746f-2bb1-7554-2d6f-726568705327');
        // Sphero LED expects 3 bytes: R,G,B
        await ledChar.writeValue(new Uint8Array([r, g, b]));
        log(`LED color set to R:${r} G:${g} B:${b}`);
      } catch (error) {
        log(`❌ LED error: ${error}`);
      }
    });
  </script>
</body>
</html>
